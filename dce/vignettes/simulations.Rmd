---
title: "Pathway enrichment by differential causal effects."
author: "Martin Pirkl"
date: "`r Sys.Date()`"
graphics: yes
output: BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{nempi}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

# Introduction

In this vignette we conduct a simulation study. This study shows that we can recover differential causal effects with high accuracy compared to other methods. First, we install and load the package. Make sure to adjust the paths through the vignette.

```{r}
library(dce)
# source("~/CausalPathways/dce/R/main.R")
# source("~/CausalPathways/dce/R/utils.R")
# source("~/CausalPathways/dce/R/simulations.R")
# library(tidyverse)
# library(purrr)
# library(graph)
# library(pcalg)
# library(assertthat)
# library(igraph)
# library(matlib)
# library(nem)
# library(mnem)
# library(expm)
# library(Linnorm)
```

```{r}
## local test parameters:
## n <- 10; m <- c(200, 200); runs <- 1; perturb <- 0; p <- "runif"; bootstrap <- 0; truepos <- 1; test <- 10

if (!exists("genes")) {
    n <- 10
} else {
    n <- genes
}
if (!exists("tumor")) {
    tumor <- 25
}
if (!exists("normal")) {
    normal <- 25
}
m <- c(tumor, normal)
if (!exists("test")) {
    test <- 1
}
if (!exists("runs")) {
    runs <- 10 # simulation runs
}
if (!exists("perturb")) {
    perturb <- 0
}
if (!exists("prob")) {
    p <- "runif" # edge prob of the dag
} else {
    p <- prob
}
if (!exists("bstrap")) {
    bootstrap <- 1
}
if (!exists("truepos")) {
    truepos <- 1
}
if (!exists("dosave")) {
    dosave <- 0
}

## fixed parameters:
mu <- 0
sd <- 1
lB <- c(0,-0)
uB <- c(0,1)
method <- "p"

simRes <- simDce(n,m,runs,mu,sd,c(lB,uB),truepos,perturb,method,p,bootstrap=bootstrap,TRUE,test=test)
# 
# pdf("temp.pdf", width = 15, height = 3)
# col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
# plot.dceSim(simRes, col = col, border = col, showMeth = c(2,5,3,6,1,4), showFeat = c(1,4,5,6,3), methNames = c("basic", "basic\n bootstrap", "full", "full\n bootstrap", "random", "correlation"))
# dev.off()

if (dosave) {
    for (filen in 1:100) {
        filename <- paste("~/CausalPathways/simulations/dce", n, # adjust path
                          paste(m, collapse = "_"), sd, perturb,
                          p, lB[1], uB[2], filen, ".rda", sep = "_")
        if (!file.exists(filename)) {
            break()
        }
    }
    
    save(simRes, file = filename)
}
```

# Running the study on an hpc cluster (LSF system)

load necessary modules

```{bash, eval=FALSE}
module add /cluster/apps/modules/modulefiles/new
module load python/3.7.1
module load bioconductor/3.6
module load curl/7.49.1
module load gmp/5.1.3
module load texlive
```

Copy the files to the cluster environment. Set the folders accordingly (e.g. CausalPathways as the working directory).

```{bash, eval=FALSE}
## adjust paths
scp CausalPathways/dce/R/main.r euler.ethz.ch:CausalPathways/dce/R/main.R
scp CausalPathways/dce/R/utils.r euler.ethz.ch:CausalPathways/dce/R/utils.R
scp CausalPathways/dce/R/simulations.r euler.ethz.ch:CausalPathways/dce/R/simulations.R
scp CausalPathways/dce/vignettes/simulations.Rmd euler.ethz.ch:CausalPathways/dce/vignettes/simulations.Rmd
```

Setup the parameters and commands.

```{bash, eval=FALSE}
ram=1000

rm error.txt

rm output.txt

rm .RData

queue=4

genes=10
perturb=0 # negative or positive fraction of edges to delete or add
runs=1
tumor=200 # samples
normal=200
bstrap=1 # if > 0 runs bootstrapping on the data
truepos=1 # if < 1, sets some causal effects equal between the tumor and normal
test=1 # number of permutations for empricial p-value
dosave=1; # save the run(s)

## knit several times to accumulate several runs
bsub -M ${ram} -q normal.${queue}h -n 1 -e error.txt -o output.txt \
	-R "rusage[mem=${ram}]" \
	"~/R/bin/Rscript --silent --no-save \
	-e \"e <- new.env(parent = globalenv()); assign('genes', ${genes}, envir = e); \
	assign('tumor', ${tumor}, envir = e); assign('normal', ${normal}, envir = e); \
	assign('runs', ${runs}, envir = e); assign('perturb', ${perturb}, envir = e); \
	assign('bstrap', ${bstrap}, envir = e); \
	assign('dosave', ${dosave}, envir = e); \
	assign('truepos', ${truepos}, envir = e); assign('test', ${test}, envir = e); \
    knitr::knit2pdf('~/CausalPathways/dce/vignettes/simulations.Rmd',
    out = '~/CausalPathways/simulations.tex', envir = e, compiler = 'latex')\""

```

Read and combine results from one or several runs.

```{r}
if (dosave) {
    library(abind)
    simRes2 <- NULL
    for (filen in 1:100) {
        filename <- paste("~/CausalPathways/simulations/dce", n, # adjust path
                          paste(m, collapse = "_"), sd, perturb,
                          p, lB[1], uB[2], filen, ".rda", sep = "_")
        if (file.exists(filename)) {
            load(filename)
            simRes2$acc <- abind(simRes2$acc, simRes$acc, along = 1)
            simRes2$gtnFeat <- abind(simRes2$gtnFeat, simRes$gtnFeat, along = 1)
            cat(paste0(filen, "."))
        }
    }
    simRes <- simRes2
    class(simRes) <- "dceSim"
}
```

Plot the results.

```{r, fig.height = 5, fig.width = 20, fig.cap = "boxplots of the simulations results"}
col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
plot.dceSim(simRes, col = col, border = col, showMeth = c(2,5,3,6,1,4),
            showFeat = c(1,4,5,6,3),
            methNames = c("basic", "basic\n bootstrap",
                          "full", "full\n bootstrap", "random", "correlation"))

## correlated with network features:
## print(cor(acc[,,1], gtnfeat[,2]))

## ## conversion between data.frame and array
## acc.df <- as.data.frame.table(acc)
## acc.arr <- xtabs(Freq ~ runs + methods + metrics, acc.df)
```

```{r}
sessionInfo()
```
