---
title: "Pathway enrichment by differential causal effects."
author: "Martin Pirkl"
date: "`r Sys.Date()`"
graphics: yes
output: BiocStyle::pdf_document
vignette: >
    %\VignetteIndexEntry{nempi}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

# Introduction

In this vignette we conduct a simulation study. This study shows that we can recover differential causal effects with high accuracy compared to other methods.

```{r}
source("dce/R/main.R")
source("dce/R/utils.R")
source("dce/R/simulations.R")

library(tidyverse)
library(purrr)
library(graph)
library(pcalg)
library(assertthat)
library(igraph)
library(matlib)
library(nem)
library(mnem)
library(expm)
library(Linnorm)

## n <- 10; m <- c(200, 200); runs <- 100; perturb <- 0; p <- "runif"; bootstrap <- 0; truepos <- 1; test <- 10

if (!exists("genes")) {
    n <- 10
} else {
    n <- genes
}
if (!exists("tumor")) {
    tumor <- 200
}
if (!exists("normal")) {
    normal <- 200
}
m <- c(tumor, normal)
if (!exists("test")) {
    test <- 0
}
if (!exists("runs")) {
    runs <- 100 # simulation runs
}
if (!exists("perturb")) {
    perturb <- 0
}
if (!exists("prob")) {
    p <- "runif" # edge prob of the dag
} else {
    p <- prob
}
if (!exists("bootstrap")) {
    bootstrap <- "none"
}
if (!exists("truepos")) {
    truepos <- 1
}
print(n)
print(m)
print(runs)
print(truepos)
print(perturb)
print(p)
print(bootstrap)
print(test)

## fixed parameters:
mu <- 0
sd <- 1
lB <- c(0,-0)
uB <- c(0,1)
method <- "p"

simRes <- simDce(n,m,runs,mu,sd,c(lB,uB),truepos,perturb,method,p,bootstrap=bootstrap,TRUE,test=test)

pdf("../temp.pdf", width = 15, height = 3)
col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
plot.dceSim(simRes, col = col, border = col, showMeth = c(2,5,3,6,1,4), showFeat = c(1,4,5,6,3), methNames = c("basic", "basic\n bootstrap", "full", "full\n bootstrap", "random", "correlation"))
dev.off()

for (filen in 1:100) {
    filename <- paste("dce/dce", n, paste(m, collapse = "_"), sd, perturb, p, lB[1], uB[2], filen, ".rda", sep = "_")
    if (!file.exists(filename)) {
        break()
    }
}

save(simRes, file = filename)
```

# Running the study on an hpc cluster (LSF system)

load necessary modules

```{bash, eval=FALSE}
module add /cluster/apps/modules/modulefiles/new

module load python/3.7.1

module load bioconductor/3.6

module load curl/7.49.1

module load gmp/5.1.3
```

Copy the files to the cluster environment. Set the folders accordingly.

```{bash, eval=FALSE}
scp dce/R/main.r euler.ethz.ch:dce/R/main.R
scp dce/R/utils.r euler.ethz.ch:dce/R/utils.R
scp dce/R/simulations.r euler.ethz.ch:dce/R/simulations.R
scp dce/vignettes/simulations.Rmd euler.ethz.ch:dce/vignettes/simulations.Rmd
```

Setup the parameters and commands.

```{bash, eval=FALSE}
ram=5000

rm error.txt

rm output.txt

rm .RData

queue=4

genes=10
perturb=0
runs=1
tumor=200
normal=200
bootstrap=0
truepos=1
test=10

## knit several times to accumulate several runs
bsub -M ${ram} -q normal.${queue}h -n 1 -e error.txt -o output.txt \
	-R "rusage[mem=${ram}]" \
	"R/bin/Rscript --silent --no-save \
	-e \"e <- new.env(parent = globalenv()); assign('genes', ${genes}, envir = e); \
	assign('tumor', ${tumor}, envir = e); assign('normal', ${normal}, envir = e); \
	assign('runs', ${runs}, envir = e); assign('perturb', ${perturb}, envir = e); \
	assign('bootstrap', ${bootstrap}, envir = e); \
	assign('truepos', ${truepos}, envir = e); assign('test', ${test}, envir = e); \
    knitr::knit('simulations.rmd', envir = e)\""

```

Read and combine results from one or several runs.

```{r}
library(abind)
simRes2 <- NULL
for (filen in 1:100) {
    filename <- paste("dce/dce", n, paste(m, collapse = "_"), sd, perturb, p, lb[1], ub[2], filen, ".rda", sep = "_")
    if (file.exists(filename)) {
        load(filename)
        simRes2$acc <- abind(simRes2$acc, simRes$acc, along = 1)
        simRes2$gtnFeat <- abind(simRes2$gtnFeat, simRes$gtnFeat, along = 1)
        cat(paste0(filen, "."))
    }
}
simRes <- simRes2
class(simRes) <- "dceSim"
```

Plot the results.

```{r}
source("dce/R/main.R")
source("dce/R/utils.R")
source("dce/R/simulations.R")
col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
plot.dceSim(simRes, col = col, border = col, showMeth = c(2,5,3,6,1,4),
            showFeat = c(1,4,5,6,3),
            methNames = c("basic", "basic\n bootstrap",
                          "full", "full\n bootstrap", "random", "correlation"))

## correlated with network features:
## print(cor(acc[,,1], gtnfeat[,2]))

## ## conversion between data.frame and array
## acc.df <- as.data.frame.table(acc)
## acc.arr <- xtabs(Freq ~ runs + methods + metrics, acc.df)
```

```{r}
sessionInfo()
```
