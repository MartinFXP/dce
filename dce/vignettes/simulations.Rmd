---
title: "Pathway enrichment by differential causal effects."
author: "Martin Pirkl"
date: "`r Sys.Date()`"
graphics: yes
output: BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{nempi}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(message=FALSE, out.width="125%", fig.align="center",
                      strip.white=TRUE, warning=FALSE, tidy=TRUE,
                      fig.height = 4, fig.width = 8, error=FALSE)
fig.cap0 <- "Boxplots of simulation results."
```

# Introduction

In this vignette we conduct a simulation study. This study shows that we can recover differential causal effects with high accuracy compared to other methods. First, we install and load the package. Make sure to adjust the paths through the vignette.

```{r}
library(dce)
library(tidyverse); library(purrr); library(graph); library(pcalg); library(assertthat); library(igraph); library(matlib); library(nem); library(mnem); library(expm); library(Linnorm); library(MASS)
```

```{r, fig.height = 4, fig.width = 14}
## local test parameters:
n <- 15 # genes
m <- c(100, 100) # samples: wt and mut
runs <- 10
perturb <- 0 # add (positive fraction) or remove (negative) edges
p <- "runif" # edge probability
bootstrap <- c(0, "NB", "Gaus") # number of bootstrap runs for the methods
truepos <- 1 # fraction of true positive effects
test <- 1 # number of permutations for empirical p-value

## fixed parameters:
method <- "p" # correlation accuracy
errDist <- "nbinom" # error model
if (errDist %in% "normal") {
    mu <- 0 # mean
    sd <- 1 # standard deviation
    lB <- c(-1,0) # negative effects intervall
    uB <- c(0,1) # positive effects intervall
} else {
    mu <- 100 # mean
    sd <- 100 # standard deviation
    lB <- c(0.5,1) # negative effects intervall
    uB <- c(1,2) # positive effects intervall
}

source("~/Documents/CausalPathways/dce/R/simulations.R"); source("~/Documents/CausalPathways/dce/R/main.R"); source("~/Documents/CausalPathways/dce/R/utils.R"); source("~/Documents/CausalPathways/dce/R/data_simulation.R")

set.seed(9427)
simRes <- simDce(n,m,runs,mu=mu,sd,c(lB,uB),truepos,perturb,method,p,bootstrap=bootstrap,verbose=TRUE,test=test,errDist=errDist,enriched=0.5)

col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
plot.dceSim(simRes, col = col, border = col, showMeth = c(2,3,1,4), showFeat = c(2,1,7,6,3), methNames = c("Gaussian", "Neg. Binomial", "random", "correlation"))

adj <- matrix(c(0,0,0,0,
                0.5,0,0,0,
                2,0.5,0,0,
                0,1.5,0,0), 4, 4)
rownames(adj) <- colnames(adj) <- 1:3
g1 <- as(adj, "graphNEL")
d1 <- simulate_data(g1, dist.dispersion = 100)
g2 <- resample_edge_weights(g1, lB = c(0.5,2), uB = c(0.5,2))
d2 <- simulate_data(g2, dist.dispersion = 100)
adj - as(g2, "matrix")
trueEffects(g1, partial = 0) - trueEffects(g2, partial = 0)
compute_differential_causal_effects(g1, d1, g2, d2, partial = 0)$dce
adj - as(g2, "matrix")
compute_differential_causal_effects(g1, d1, g2, d2, partial = 1)$dce
cor(as.vector(adj - as(g2, "matrix")), as.vector(compute_differential_causal_effects(g1, d1, g2, d2, partial = 1)$dce))
compute_enrichment(g1, d1, d2)


```

```{r}

dosave <- 0 # adjust this as needed
if (dosave) {
    for (filen in 1:100) {
        # adjust path
        filename <- paste("~/CausalPathways/simulations/dce", n,
                          paste(m, collapse = "_"), sd, perturb,
                          p, lB[1], uB[2], filen, ".rda", sep = "_")
        if (!file.exists(filename)) {
            break()
        }
    }
    save(simRes, file = filename)
}

p2 <- 0.1
normal <- create_random_DAG(n, p2, lB, uB)
tumor <- resample_edge_weights(normal, lB, uB, truepos)
dn <- simulate_data_old(normal, m[2], normpars = c(mu,sd), errDist=errDist)
dt <- simulate_data_old(tumor, m[1], normpars = c(mu,sd), errDist=errDist)
dcei <- compute_differential_causal_effects(normal, dn,tumor, dt, method = "full",errDist = errDist)

```

# Stuff to be deleted pre-publication

```{bash, eval=FALSE}
module add /cluster/apps/modules/modulefiles/new
module load python/3.7.1
module load bioconductor/3.6
module load curl/7.49.1
module load gmp/5.1.3
module load texlive

scp CausalPathways/dce/R/main.r euler.ethz.ch:CausalPathways/dce/R/main.R
scp CausalPathways/dce/R/utils.r euler.ethz.ch:CausalPathways/dce/R/utils.R
scp CausalPathways/dce/R/simulations.r euler.ethz.ch:CausalPathways/dce/R/simulations.R
scp CausalPathways/dce/vignettes/simulations.Rmd euler.ethz.ch:CausalPathways/dce/vignettes/simulations.Rmd

ram=1000

rm error.txt

rm output.txt

rm .RData

queue=4

genes=100
perturb=0 # negative or positive fraction of edges to delete or add
runs=1
tumor=200 # samples
normal=200
bstrap=0 # if > 0 runs bootstrapping on the data
truepos=1 # if < 1, sets some causal effects equal between the tumor and normal
test=0 # number of permutations for empricial p-value
dosave=1; # save the run(s)

## knit several times to accumulate several runs
bsub -M ${ram} -q normal.${queue}h -n 1 -e error.txt -o output.txt \
	-R "rusage[mem=${ram}]" \
	"~/R/bin/Rscript --silent --no-save \
	-e \"e <- new.env(parent = globalenv()); assign('genes', ${genes}, envir = e); \
	assign('tumor', ${tumor}, envir = e); assign('normal', ${normal}, envir = e); \
	assign('runs', ${runs}, envir = e); assign('perturb', ${perturb}, envir = e); \
	assign('bstrap', ${bstrap}, envir = e); \
	assign('dosave', ${dosave}, envir = e); \
	assign('truepos', ${truepos}, envir = e); assign('test', ${test}, envir = e); \
    knitr::knit2pdf('~/CausalPathways/dce/vignettes/simulations.Rmd',
    out = '~/CausalPathways/simulations.tex', envir = e, compiler = 'latex')\""

```


```{r}
dosave <- 0 # adjust this as needed
if (dosave) {
    library(abind)
    simRes2 <- NULL
    for (filen in 1:100) {
        filename <- paste("~/CausalPathways/simulations/dce", n, # adjust path
                          paste(m, collapse = "_"), sd, perturb,
                          p, lB[1], uB[2], filen, ".rda", sep = "_")
        if (file.exists(filename)) {
            load(filename)
            simRes2$acc <- abind(simRes2$acc, simRes$acc, along = 1)
            simRes2$gtnFeat <- abind(simRes2$gtnFeat, simRes$gtnFeat, along = 1)
            cat(paste0(filen, "."))
        }
    }
    simRes <- simRes2
    class(simRes) <- "dceSim"
}
```

Plot the results.

```{r, fig.cap=fig.cap0}
col <- rgb(c(0.5,1,0,0.1),c(0.5,0,0,0.1),c(0.5,0,1,0.1),0.75)
plot.dceSim(simRes, col = col, border = col, showMeth = c(2,5,3,6,1,4),
            showFeat = c(1,4,5,6,3),
            methNames = c("basic", "basic\n bootstrap",
                          "full", "full\n bootstrap", "random", "correlation"))

## correlated with network features:
## print(cor(acc[,,1], gtnfeat[,2]))

## ## conversion between data.frame and array
## acc.df <- as.data.frame.table(acc)
## acc.arr <- xtabs(Freq ~ runs + methods + metrics, acc.df)
```

```{r}
sessionInfo()
```
